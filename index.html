<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>

	<script type='text/javascript' src="javascript/queryselector-scope.js"></script>
	<script type='text/javascript' src="javascript/vkbeautify.js"></script>

	<script type='text/javascript' src="javascript/class.js"></script>
	<script type='text/javascript' src="javascript/class.events.js"></script>

	<script type='text/javascript' src="javascript/streaming.data.js"></script>
	<script type='text/javascript' src="javascript/streaming.io.js"></script>
	<script type='text/javascript' src="javascript/streaming.js"></script>
	<script type='text/javascript' src="javascript/streaming.message.js"></script>
	<script type='text/javascript' src="javascript/streaming.util.js"></script>
	<script type='text/javascript' src="javascript/streaming.wps.js"></script>
	<script type='text/javascript' src="javascript/streaming.client.js"></script>

	<script type="text/javascript">
		(function(){
			var options = {
				streamingWPS: "http://localhost:12121/WebProcessingService",
				streamingId: "com.github.autermann.wps.streaming.delegate.DelegatingStreamingAlgorithm",
				remoteWPS: "http://localhost:12121/WebProcessingService",
				remoteId: "com.github.autermann.wps.streaming.TestAlgorithm"
			};

			Streaming.Client.start(options, function(processInfo) {
				var client, count = 0, expected = 10;
				console.debug("Started process: ", processInfo);
				function onMessage(message) {
					if ((++count) >= expected) {
						client.stop();
						client.close();
					}
				}
				client = new Streaming.Client(processInfo)
					.on("open", function() {
						console.debug("Client opened");
					})
					.on("close", function() {
					 	console.debug("Client closed");
					})
					.on("error", function(cause) {
						console.debug("Client failed", cause);
					})
					.on("outputmessage", function(message) {
						console.debug("Received Output");
						onMessage(message);
					})
					.on("errormessage", function(message) {
						console.debug("Received Error", message);
						onMessage(message);
					})
					.on("stopmessage", function(message) {
						console.debug("Received Stop message", message);
						onMessage(message);
					})
					.listen();

				function createInputMessage(a, b, dependencies) {
					dependencies = dependencies || [];
					return new Streaming.Message.Input({
						relatedMessages: dependencies,
						inputs: [
							new Streaming.Input.Data("a", new Streaming.Data.Literal("xs:int", a)),
							new Streaming.Input.Data("b", new Streaming.Data.Literal("xs:int", b))
						]
					});
				}

				var i, messages = [];
				for (i = 0; i < expected; ++i) {
					messages.push(createInputMessage(1, 1));
				}
				for (i = 0; i < messages.length; ++i) {
					client.send(messages[i]);
				}
			});
		})();
	</script>
</head>
<body>
</body>

</html>